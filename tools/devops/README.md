# Azure DevOps Build System Documentation

This document describes how the Azure DevOps YAML pipelines work for the macios repository.

> [!NOTE]
> This document was AI generated by Copilot.

## Overview

The build system is located in `tools/devops/automation/` and uses Azure DevOps YAML pipelines with extensive use of templates for reusability. The system supports both CI (Continuous Integration) builds and PR (Pull Request) builds.

## Directory Structure

```
tools/devops/
├── automation/
│   ├── build-pipeline.yml          # Main CI build pipeline
│   ├── build-pull-request.yml      # Main PR build pipeline
│   ├── vs-insertion.yml            # Visual Studio insertion pipeline
│   ├── run-*.yml                   # Post-build triggered pipelines
│   ├── scripts/                    # PowerShell and Bash scripts
│   │   ├── bash/                   # Shell scripts for build/test
│   │   └── *.ps1, *.psm1           # PowerShell modules
│   └── templates/                  # Reusable YAML templates
│       ├── build/                  # Build-related templates
│       ├── common/                 # Shared utility templates
│       ├── governance/             # Security/compliance templates
│       ├── mac/                    # macOS test templates
│       ├── pipelines/              # Pipeline extension templates
│       ├── release/                # Release/signing templates
│       ├── tests/                  # Test execution templates
│       ├── variables/              # Variable group definitions
│       └── windows/                # Windows test templates
└── governance/                     # Security baselines and suppressions
```

## Main Pipelines

### 1. CI Build Pipeline (`build-pipeline.yml`)

The primary CI pipeline that triggers on commits to main and release branches.

**Triggers:**
- All branches except: `dev/*`, `darc-*`, `backport-pr-*`, `lego/*`, `locfiles/*`, `copilot/*`, `dependabot/*`
- Excludes paths: `.github`, `docs`, `README.md`, etc.

**Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `provisionatorChannel` | string | `latest` | Provisionator channel for dependencies |
| `macOSName` | string | `Sequoia` | macOS version for build agents |
| `runGovernanceTests` | boolean | `true` | Run security/compliance checks |
| `forceInsertion` | boolean | `false` | Force VS insertion even on non-release branches |
| `pushNugets` | boolean | `true` | Push NuGets to feeds |
| `pushNugetsToMaestro` | boolean | `true` | Publish to Maestro for .NET |

**Stages:**
1. **Configure** - Parse labels, configure platforms, create test matrix
2. **Build** - Build packages and NuGets on macOS
3. **Prepare Release** (conditional) - Sign NuGets, convert to MSI, push to feeds
4. **Localization** (main branch only) - Handle localization updates

### 2. PR Build Pipeline (`build-pull-request.yml`)

Triggered on pull requests to validate changes before merge.

**Triggers:**
- PR to any branch
- Also triggers on specific branch pushes: `dev/*`, `darc-*`, etc.

**Key Differences from CI:**
- Uses `PRBuildPool` instead of `CIBuildPool`
- `pushNugets: false` - Does not publish NuGets
- `pushNugetsToMaestro: false` - Does not publish to Maestro

### 3. Post-Build Test Pipelines

These pipelines are triggered after the main build completes:

| Pipeline | Source | Purpose |
|----------|--------|---------|
| `run-post-ci-build-tests.yml` | CI build | Run simulator tests after CI build |
| `run-post-pr-build-tests.yml` | PR build | Run simulator tests after PR build |
| `run-ci-api-diff.yml` | CI configure stage | Generate API diff for CI |
| `run-pr-api-diff.yml` | PR configure stage | Generate API diff for PR |
| `run-post-ci-build-api-scan.yml` | CI build | Run APIScan security checks |
| `run-post-pr-build-api-scan.yml` | PR build | Run APIScan security checks |
| `run-post-ci-build-vs-insertion.yml` | CI build | Sign and prepare for VS insertion |

### 4. VS Insertion Pipeline (`vs-insertion.yml`)

Creates Visual Studio insertion drops and opens PRs.

**Trigger:** Manual or triggered from release pipelines

**Actions:**
- Downloads signed NuGets
- Creates VS Drop
- Pushes to shipping feed
- Opens VS insertion PR

### 5. Nightly CodeQL (`run-nightly-codeql.yml`)

Scheduled security analysis pipeline.

**Schedule:** Daily at 5:00 UTC on `main` branch

**Purpose:** Run CodeQL security analysis without blocking builds

## Core Templates

### Main Stage Template (`templates/main-stage.yml`)

Orchestrates the entire build process:

```yaml
stages:
  - configure_build    # Configure platforms, parse labels
  - build_packages     # Build NuGets and packages
  - prepare_release    # (conditional) Sign and publish
```

**Key Variables from Configure Stage:**
- `DOTNET_PLATFORMS` - Enabled .NET platforms
- `INCLUDE_DOTNET_IOS`, `INCLUDE_DOTNET_MACCATALYST`, etc. - Platform flags
- `TEST_MATRIX` - Dynamic test configuration matrix
- `APISCAN_MATRIX` - APIScan configuration matrix

### Build Templates (`templates/build/`)

| Template | Purpose |
|----------|---------|
| `build-stage.yml` | Job definition for main build |
| `build.yml` | Core build steps (checkout, provision, make) |
| `build-pkgs.yml` | Build and publish NuGet packages |
| `build-mac-tests-stage.yml` | Build macOS-specific tests |
| `api-diff-stage.yml` | API diff detection jobs |
| `api-diff-build-and-detect.yml` | Build and compute API differences |
| `api-diff-process-results.yml` | Upload API diff results |
| `download-artifacts.yml` | Download build artifacts |

### Common Templates (`templates/common/`)

| Template | Purpose |
|----------|---------|
| `checkout.yml` | Checkout code with GitHub merge handling |
| `configure.yml` | Parse labels, configure platforms, create matrices |
| `setup.yml` | Agent cleanup, CodeQL setup, environment prep |
| `teardown.yml` | Post-build cleanup, certificate removal |
| `load_configuration.yml` | Load configuration from previous pipeline |
| `install-qa-provisioning-profiles.yml` | Install Apple provisioning profiles |
| `publish-pipeline-artifact.yml` | Publish artifacts (1ES compatible) |
| `mac-agent-logs.yml` | Collect and upload agent logs |

### Test Templates (`templates/tests/`)

| Template | Purpose |
|----------|---------|
| `stage.yml` | Main test stage with matrix strategy |
| `build.yml` | Test setup and execution |
| `run-tests.yml` | Core test execution steps |
| `publish-results.yml` | Collect and publish test results |
| `publish-html.yml` | Generate and publish HTML test reports |
| `download-artifacts.yml` | Download test dependencies |

### Platform-Specific Templates

**macOS Tests (`templates/mac/`):**
- `stage.yml` - macOS test stage definition
- `build.yml` - macOS test execution

**Windows Tests (`templates/windows/`):**
- `stage.yml` - Windows integration test stage
- `reserve-mac.yml` - Reserve macOS agent for remote testing
- `build.yml` - Windows test execution
- `reenable-mac.yml` - Release reserved macOS agent

### Release Templates (`templates/release/`)

| Template | Purpose |
|----------|---------|
| `vs-insertion-prep.yml` | Sign NuGets, convert to MSI, push to feeds |

**Signing Process:**
1. Sign NuGets using `sign-artifacts/jobs/v4.yml@yaml-templates`
2. Convert NuGets to MSI using `nuget-msi-convert/job/v4.yml@yaml-templates`
3. Verify signatures with `MicroBuildCodesignVerify`
4. Push to artifact drops and Maestro

### Governance Templates (`templates/governance/`)

| Template | Purpose |
|----------|---------|
| `stage.yml` | APIScan stage definition |
| `apiscan.yml` | APIScan execution and reporting |

## Variable Groups

Defined in `templates/variables/`:

### `common.yml`
Core variables used across all pipelines:
- Build pools: `PRBuildPool`, `CIBuildPool`
- SDK versions: `DotNetSdkVersion`, `DotNetPreviewSdkVersion`
- Environment: `xcodeChannel`, `minimumMacOSVersion`
- Azure DevOps groups: `XamarinCompatLab`, `Xamarin-Secrets`, etc.

### `api-scan.yml`
APIScan-specific variables:
- `TeamName: xamarin-macios`

### `signing.yml`
Signing-related variable groups:
- `Xamarin Signing`
- `Xamarin Release`
- `Xamarin Notarization`

## Scripts

### PowerShell Modules (`scripts/*.psm1`)

| Module | Purpose |
|--------|---------|
| `MaciosCI.psd1` | Main module manifest |
| `Artifacts.psm1` | Artifact handling |
| `GitHub.psm1` | GitHub API interactions |
| `MLaunch.psm1` | mlaunch tool management |
| `RemoteMac.psm1` | Remote Mac agent operations |
| `StaticPages.psm1` | Static HTML generation |
| `System.psm1` | System utilities |
| `TestConfiguration.psm1` | Test matrix configuration |
| `TestResults.psm1` | Test result processing |
| `VSTS.psm1` | Azure DevOps API interactions |
| `Governance.psm1` | Governance/compliance utilities |

### Bash Scripts (`scripts/bash/`)

| Script | Purpose |
|--------|---------|
| `build-macios.sh` | Main build script |
| `build-nugets.sh` | NuGet package creation |
| `configure-build.sh` | Configure build environment |
| `configure-platforms.sh` | Detect enabled platforms |
| `configure-decisions.sh` | Make test/build decisions |
| `install-workloads.sh` | Install .NET workloads |
| `collect-and-upload-crash-reports.sh` | Crash report collection |
| `clean-bot.sh` | Agent cleanup |
| `validate-xcode-channel.sh` | Validate Xcode version |

## Build Agent Requirements

### macOS Agents

Demands:
- `Agent.OS -equals Darwin`
- `Agent.OSVersion -gtVersion $(minimumMacOSVersion)`
- `macOS.Name -equals <Sequoia|Sonoma|etc.>`
- `XcodeChannel -equals <Stable|Beta>`

Pools:
- **PR builds:** `VSEng-Xamarin-RedmondMacBuildPool-iOS-Untrusted`
- **CI builds:** `VSEng-Xamarin-RedmondMacBuildPool-iOS-Trusted`

### Windows Agents

Used for:
- APIScan
- Windows integration tests
- NuGet signing and publishing

Pool: `AzurePipelines-EO` with `1ESPT-Windows2022` image

## Test Matrix Configuration

The configure stage dynamically generates test matrices based on:

1. **PR Labels** - Control which tests run
2. **Enabled Platforms** - iOS, macOS, tvOS, Mac Catalyst
3. **Test Categories** - cecil, dotnettests, fsharp, generator, introspection, etc.

### Supported Test Labels

| Label | Effect |
|-------|--------|
| `skip-all-tests` | Skip all test execution |
| `run-ios-tests` | Run iOS tests |
| `run-tvos-tests` | Run tvOS tests |
| `run-mac-tests` | Run macOS tests |
| `run-maccatalyst-tests` | Run Mac Catalyst tests |
| `skip-packages` | Skip package creation |
| `skip-nugets` | Skip NuGet creation |
| `skip-signing` | Skip signing |
| `skip-api-comparison` | Skip API diff |

### Test Configurations

```yaml
testConfigurations:
  - label: cecil          # Cecil-based tests
  - label: dotnettests    # .NET platform tests (split by platform)
  - label: fsharp         # F# tests
  - label: framework      # Framework tests
  - label: generator      # Binding generator tests
  - label: introspection  # Runtime introspection tests
  - label: linker         # Linker tests
  - label: monotouch      # MonoTouch tests (split by platform)
  - label: msbuild        # MSBuild tests
  - label: xcframework    # XCFramework tests
  - label: xtro           # Xtro tests
  - label: windows        # Windows integration tests
```

## Security and Compliance

### SDL (Security Development Lifecycle)

The 1ES pipeline template includes:
- **CredScan** - Credential scanning
- **PoliCheck** - Policy compliance checking
- **CodeQL** - Static code analysis (nightly)
- **APIScan** - API security scanning
- **TSA** - Security analysis reporting

### Governance Files (`governance/`)

| File | Purpose |
|------|---------|
| `baselines.gdnbaselines` | Security baseline definitions |
| `suppress.gdnsuppress` | Known issue suppressions |
| `falsepositives.gdnsuppress` | False positive suppressions |
| `tsa_config.gdntsa` | TSA upload configuration |
| `CredScanSuppressions.json` | CredScan suppressions |
| `PoliCheckExclusions.xml` | PoliCheck exclusions |

## Artifacts

### Build Artifacts

| Artifact | Contents |
|----------|----------|
| `not-signed-package` | Unsigned NuGet packages |
| `not-signed-package-symbols` | Debug symbols |
| `nuget-signed` | Signed NuGet packages |
| `vs-msi-nugets` | MSI-wrapped NuGets for VS |
| `WorkloadRollback` | Workload version manifest |
| `build-configuration` | Build configuration JSON |
| `package-test-libraries` | Pre-built test dependencies |
| `Build.props` | Build properties file |
| `all-binlogs` | MSBuild binary logs |

### Test Artifacts

| Artifact | Contents |
|----------|----------|
| `HtmlReport-*` | HTML test reports |
| `TestSummary-*` | Test summary markdown |
| `diagnostic-simulator-info` | Simulator diagnostics |
| `crash-reports-*` | Crash reports |

## Pipeline Flow

### CI Build Flow

```
┌─────────────────┐
│  Push to main   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────────┐
│ Configure Build │────►│ API Diff (parallel) │
└────────┬────────┘     └─────────────────────┘
         │
         ▼
┌─────────────────┐
│ Build Packages  │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌───────┐  ┌─────────────────┐
│ Tests │  │ Prepare Release │
└───────┘  └────────┬────────┘
                    │
         ┌──────────┼──────────┐
         │          │          │
         ▼          ▼          ▼
    ┌────────┐  ┌───────┐  ┌──────────┐
    │  Sign  │  │  MSI  │  │ APIScan  │
    └───┬────┘  └───┬───┘  └──────────┘
        │          │
        ▼          ▼
    ┌─────────────────┐
    │  Push NuGets    │
    └────────┬────────┘
             │
             ▼
    ┌─────────────────┐
    │  VS Insertion   │
    └─────────────────┘
```

### PR Build Flow

```
┌─────────────────┐
│    Open PR      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────────┐
│ Configure Build │────►│ API Diff (parallel) │
└────────┬────────┘     └─────────────────────┘
         │
         ▼
┌─────────────────┐
│ Build Packages  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Simulator Tests │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Publish Results │
└─────────────────┘
```

## YAML File Dependency Diagrams

### CI Build YAML Structure

This diagram shows how YAML files are interconnected for CI builds:

```
build-pipeline.yml (Entry Point - CI)
│
├─► extends: azure-pipelines/MicroBuild.1ES.Official.yml@CustomPipelineTemplates
│
├─► variables:
│   ├─► templates/vsts-variables.yml
│   ├─► templates/variables/common.yml
│   ├─► templates/variables/api-scan.yml
│   └─► templates/variables/signing.yml
│
├─► resources:
│   ├─► xamarin.yaml-templates
│   ├─► macios-adr
│   └─► 1ESPipelineTemplates/MicroBuildTemplate
│
└─► stages:
    │
    ├─► templates/main-stage.yml
    │   │
    │   ├─► Stage: configure_build
    │   │   └─► templates/common/configure.yml
    │   │       ├─► templates/common/checkout.yml
    │   │       │   └─► sdk-unified/steps/checkout/v1.yml@yaml-templates
    │   │       └─► scripts/bash/configure-platforms.sh
    │   │       └─► scripts/bash/configure-decisions.sh
    │   │
    │   ├─► Stage: build_packages
    │   │   └─► templates/build/build-stage.yml
    │   │       └─► templates/build/build-pkgs.yml
    │   │           └─► templates/build/build.yml
    │   │               ├─► templates/common/checkout.yml
    │   │               ├─► templates/common/setup.yml
    │   │               │   └─► agent-cleanser/v1.yml@yaml-templates
    │   │               ├─► install-certificates.yml@yaml-templates
    │   │               ├─► scripts/bash/build-macios.sh
    │   │               ├─► scripts/bash/build-nugets.sh
    │   │               ├─► templates/common/install-qa-provisioning-profiles.yml
    │   │               ├─► templates/common/publish-pipeline-artifact.yml
    │   │               └─► templates/common/teardown.yml
    │   │                   ├─► uninstall-certificates/v1.yml@yaml-templates
    │   │                   └─► templates/common/mac-agent-logs.yml
    │   │
    │   └─► Stage: prepare_release (conditional)
    │       └─► templates/release/vs-insertion-prep.yml
    │           ├─► sign-artifacts/jobs/v4.yml@yaml-templates
    │           ├─► nuget-msi-convert/job/v4.yml@yaml-templates
    │           └─► templates/common/publish-pipeline-artifact.yml
    │
    └─► localization/v1.yml@yaml-templates (main branch only)

                    ┌──────────────────────────────────────┐
                    │     TRIGGERED PIPELINES (CI)         │
                    └──────────────────────────────────────┘

run-post-ci-build-tests.yml ─────────────────────────────────────────────────┐
│                                                                            │
└─► extends: templates/pipelines/run-tests-pipeline.yml                      │
    │                                                                        │
    └─► templates/tests-stage.yml                                            │
        │                                                                    │
        ├─► Stage: configure_build                                           │
        │   └─► templates/common/load_configuration.yml                      │
        │                                                                    │
        ├─► Stage: simulator_tests                                           │
        │   └─► templates/tests/stage.yml                                    │
        │       └─► templates/tests/build.yml                                │
        │           ├─► templates/tests/download-artifacts.yml               │
        │           └─► templates/tests/run-tests.yml                        │
        │                                                                    │
        ├─► Stage: build_macos_tests                                         │
        │   └─► templates/build/build-mac-tests-stage.yml                    │
        │       └─► templates/build/build-mac-tests.yml                      │
        │                                                                    │
        ├─► Stage: mac_*_tests (multiple)                                    │
        │   └─► templates/mac/stage.yml                                      │
        │       └─► templates/mac/build.yml                                  │
        │                                                                    │
        ├─► Stage: windows_integration                                       │
        │   └─► templates/windows/stage.yml                                  │
        │       ├─► templates/windows/reserve-mac.yml                        │
        │       ├─► templates/windows/build.yml                              │
        │       └─► templates/windows/reenable-mac.yml                       │
        │                                                                    │
        └─► Stage: publish_test_results                                      │
            └─► templates/tests/publish-results.yml                          │
                └─► templates/tests/publish-html.yml                         │
                                                                             │
run-ci-api-diff.yml ─────────────────────────────────────────────────────────┤
│                                                                            │
└─► extends: templates/pipelines/api-diff-pipeline.yml                       │
    │                                                                        │
    └─► templates/api-diff-stage.yml                                         │
        │                                                                    │
        ├─► Stage: configure_build                                           │
        │   └─► templates/common/configure.yml                               │
        │                                                                    │
        └─► Stage: generate_api_diff                                         │
            └─► templates/build/api-diff-stage.yml                           │
                ├─► templates/build/api-diff-build-and-detect.yml            │
                └─► templates/build/api-diff-process-results.yml             │
                                                                             │
run-post-ci-build-api-scan.yml ──────────────────────────────────────────────┤
│                                                                            │
└─► extends: templates/pipelines/run-api-scan.yml                            │
    │                                                                        │
    ├─► Stage: configure_build                                               │
    │   └─► templates/common/configure.yml                                   │
    │                                                                        │
    └─► Stage: governance_checks                                             │
        └─► templates/governance/stage.yml                                   │
            └─► templates/governance/apiscan.yml                             │
                                                                             │
run-post-ci-build-vs-insertion.yml ──────────────────────────────────────────┤
│                                                                            │
└─► extends: azure-pipelines/MicroBuild.1ES.Official.yml@CustomPipelineTemplates
    │                                                                        │
    └─► templates/release/vs-insertion-prep.yml                              │
        ├─► sign-artifacts/jobs/v4.yml@yaml-templates                        │
        ├─► nuget-msi-convert/job/v4.yml@yaml-templates                      │
        └─► push to Maestro/feeds                                            │
                                                                             │
run-nightly-codeql.yml ──────────────────────────────────────────────────────┘
│
└─► templates/build/build.yml (with disableCodeQL: false)
```

### PR Build YAML Structure

This diagram shows how YAML files are interconnected for PR builds:

```
build-pull-request.yml (Entry Point - PR)
│
├─► extends: azure-pipelines/MicroBuild.1ES.Official.yml@CustomPipelineTemplates
│
├─► variables:
│   ├─► templates/variables/common.yml
│   └─► templates/variables/api-scan.yml
│
├─► resources:
│   ├─► xamarin.yaml-templates
│   ├─► macios-adr
│   └─► 1ESPipelineTemplates/MicroBuildTemplate
│
└─► stages:
    │
    └─► templates/main-stage.yml (isPR: true)
        │
        ├─► Stage: configure_build
        │   └─► templates/common/configure.yml
        │       ├─► templates/common/checkout.yml
        │       │   ├─► sdk-unified/steps/checkout/v1.yml@yaml-templates
        │       │   ├─► scripts/undo_github_merge.ps1
        │       │   └─► checkout: macios-adr, yaml-templates
        │       ├─► scripts/bash/configure-platforms.sh
        │       ├─► scripts/bash/validate-xcode-channel.sh
        │       ├─► scripts/parse_pr_labels.ps1 (via MaciosCI.psd1)
        │       ├─► scripts/bash/configure-decisions.sh
        │       └─► templates/common/publish-pipeline-artifact.yml
        │
        └─► Stage: build_packages
            └─► templates/build/build-stage.yml
                │
                └─► Job: build
                    └─► templates/build/build-pkgs.yml
                        │
                        └─► templates/build/build.yml
                            │
                            ├─► templates/common/checkout.yml
                            │
                            ├─► templates/common/setup.yml
                            │   ├─► agent-cleanser/v1.yml@yaml-templates
                            │   ├─► scripts/disable-codeql-arm64.sh
                            │   ├─► scripts/bash/fix-github-ssh-key.sh
                            │   ├─► scripts/show_bot_info.ps1
                            │   ├─► scripts/bash/clean-bot.sh
                            │   └─► scripts/bash/remove-ui-prompt.sh
                            │
                            ├─► install-certificates.yml@yaml-templates
                            │
                            ├─► provisionator@2 task
                            │   └─► build-provisioning.csx
                            │
                            ├─► scripts/parse_pr_labels.ps1
                            │
                            ├─► scripts/bash/configure-build.sh
                            │
                            ├─► templates/common/install-qa-provisioning-profiles.yml
                            │   └─► scripts/install-qa-provisioning-profiles.sh
                            │
                            ├─► scripts/bash/build-macios.sh (main build)
                            │
                            ├─► [buildSteps from build-pkgs.yml]:
                            │   ├─► scripts/bash/build-nugets.sh
                            │   ├─► scripts/bash/generate-workload-rollback.sh
                            │   └─► templates/common/publish-pipeline-artifact.yml (×5)
                            │       ├─► WorkloadRollback.json
                            │       ├─► not-signed-package
                            │       ├─► not-signed-package-symbols
                            │       ├─► package-test-libraries
                            │       └─► Build.props
                            │
                            ├─► templates/common/teardown.yml
                            │   ├─► uninstall-certificates/v1.yml@yaml-templates
                            │   └─► templates/common/mac-agent-logs.yml
                            │
                            └─► scripts/bash/collect-and-upload-crash-reports.sh

                    ┌──────────────────────────────────────┐
                    │     TRIGGERED PIPELINES (PR)         │
                    └──────────────────────────────────────┘

run-post-pr-build-tests.yml ─────────────────────────────────────────────────┐
│                                                                            │
└─► extends: templates/pipelines/run-tests-pipeline.yml                      │
    │   └─► variables: templates/variables/common.yml                        │
    │                                                                        │
    └─► templates/tests-stage.yml                                            │
        │                                                                    │
        ├─► Stage: configure_build                                           │
        │   └─► Job: configure                                               │
        │       └─► templates/common/load_configuration.yml                  │
        │           └─► Download: build-configuration artifact               │
        │                                                                    │
        ├─► Stage: simulator_tests                                           │
        │   └─► templates/tests/stage.yml                                    │
        │       │   strategy: matrix from SIMULATOR_TEST_MATRIX              │
        │       │                                                            │
        │       └─► Job: tests                                               │
        │           └─► templates/tests/build.yml                            │
        │               ├─► templates/common/checkout.yml                    │
        │               ├─► templates/common/setup.yml                       │
        │               ├─► templates/tests/download-artifacts.yml           │
        │               │   └─► Download: not-signed-package,                │
        │               │       package-test-libraries, WorkloadRollback     │
        │               └─► templates/tests/run-tests.yml                    │
        │                   ├─► scripts/initialize-test-output-variables.ps1 │
        │                   ├─► scripts/set_xtro_workloads.ps1               │
        │                   ├─► scripts/bash/install-workloads.sh            │
        │                   ├─► make -C tests jenkins                        │
        │                   └─► Publish: HtmlReport, TestSummary, binlogs    │
        │                                                                    │
        ├─► Stage: build_macos_tests                                         │
        │   └─► templates/build/build-mac-tests-stage.yml                    │
        │       └─► templates/build/build-mac-tests.yml                      │
        │           └─► templates/build/build.yml (test build variant)       │
        │                                                                    │
        ├─► Stage: mac_12_m1, mac_13_m1, mac_14_x64, mac_15_arm64, mac_26_arm64
        │   └─► templates/mac/stage.yml (for each config)                    │
        │       └─► Job: run_tests                                           │
        │           └─► templates/mac/build.yml                              │
        │                                                                    │
        ├─► Stage: windows_integration                                       │
        │   └─► templates/windows/stage.yml                                  │
        │       ├─► Job: mac_reservation                                     │
        │       │   └─► templates/windows/reserve-mac.yml                    │
        │       ├─► Job: tests                                               │
        │       │   └─► templates/windows/build.yml                          │
        │       │       └─► scripts/run-windows-tests.ps1                    │
        │       └─► Job: mac_reenable                                        │
        │           └─► templates/windows/reenable-mac.yml                   │
        │                                                                    │
        └─► Stage: publish_test_results                                      │
            └─► templates/tests/publish-results.yml                          │
                ├─► Job: publish_test_results                                │
                │   └─► templates/tests/publish-html.yml                     │
                └─► Job: publish_skipped_tests (if skip-all-tests label)     │
                                                                             │
run-pr-api-diff.yml ─────────────────────────────────────────────────────────┤
│                                                                            │
└─► extends: templates/pipelines/api-diff-pipeline.yml                       │
    │   └─► variables: templates/variables/common.yml                        │
    │                                                                        │
    └─► templates/api-diff-stage.yml                                         │
        │                                                                    │
        ├─► Stage: configure_build                                           │
        │   └─► templates/common/configure.yml                               │
        │                                                                    │
        └─► Stage: generate_api_diff                                         │
            └─► templates/build/api-diff-stage.yml                           │
                │                                                            │
                ├─► Job: api_diff                                            │
                │   └─► templates/build/api-diff-build-and-detect.yml        │
                │       ├─► templates/build/build.yml                        │
                │       └─► API comparison scripts                           │
                │                                                            │
                └─► Job: publish_change_detection_results                    │
                    └─► templates/build/api-diff-process-results.yml         │
                        └─► Upload to VSDrops, post GitHub comment           │
                                                                             │
run-post-pr-build-api-scan.yml ──────────────────────────────────────────────┘
│
└─► extends: templates/pipelines/run-api-scan.yml
    │
    ├─► Stage: configure_build
    │   └─► templates/common/configure.yml
    │
    └─► Stage: governance_checks
        └─► templates/governance/stage.yml
            │   strategy: matrix from APISCAN_MATRIX
            │
            └─► Job: apiscan
                └─► templates/governance/apiscan.yml
                    ├─► templates/common/checkout.yml
                    ├─► Download: not-signed-package
                    ├─► scripts/prepare_workload_apiscan.ps1
                    ├─► APIScan@2 task
                    ├─► PublishSecurityAnalysisLogs@3
                    ├─► SdtReport@2
                    └─► TSAUpload@2
```

### Legend

```
Symbol  Meaning
──────  ─────────────────────────────────────
─►      Template inclusion / stage dependency
│       Hierarchy level
├─►     Child template/step (more siblings follow)
└─►     Last child template/step
@       External repository reference (e.g., @yaml-templates)
(×N)    Template called N times
```

### Key Differences: CI vs PR

| Aspect | CI Build | PR Build |
|--------|----------|----------|
| Entry Point | `build-pipeline.yml` | `build-pull-request.yml` |
| Pool | `CIBuildPool` (Trusted) | `PRBuildPool` (Untrusted) |
| Push NuGets | Yes | No |
| Maestro | Yes | No |
| VS Insertion | Yes (on release branches) | No |
| Signing | Real signing | Skipped |
| vsts-variables.yml | Included | Not included |
| signing.yml variables | Included | Not included |
| Localization | Yes (main only) | No |

## External Resources

### Repository References

| Repository | Purpose |
|------------|---------|
| `xamarin.yaml-templates` | Shared YAML templates |
| `macios-adr` | API diff reference data |
| `1ESPipelineTemplates/MicroBuildTemplate` | 1ES compliance templates |

### Azure DevOps Variable Groups

| Group | Contents |
|-------|----------|
| `XamarinCompatLab` | Lab environment settings |
| `xamops-azdev-secrets` | Azure DevOps secrets |
| `Xamarin-Secrets` | General Xamarin secrets |
| `Xamarin Signing` | Code signing certificates |
| `Xamarin Notarization` | Apple notarization credentials |
| `Xamarin Release` | Release automation settings |

## Troubleshooting

### Common Issues

1. **Build agent not found**
   - Check agent demands match available agents
   - Verify `macOSName` and `XcodeChannel` values

2. **Test matrix empty**
   - Check PR labels are set correctly
   - Verify `configure` stage completed successfully

3. **Signing failures**
   - Ensure certificate variable groups are accessible
   - Check keychain password is correct

4. **API diff failures**
   - Verify `macios-adr` repository is accessible
   - Check base commit exists

### Debug Mode

Enable verbose logging:
```yaml
variables:
  - name: system.debug
    value: true
```

### Useful Commands

View build configuration:
```bash
cat configure.inc
```

Check enabled platforms:
```bash
echo $DOTNET_PLATFORMS
```

View test matrix:
```bash
echo $TEST_MATRIX | jq .
```
